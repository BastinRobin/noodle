#!/usr/bin/env node

var connect  = require('connect'),
    http     = require('http'),
    noodlemw = require('../lib/noodle-middleware'),
    limiter  = require('connect-ratelimit'),

    port     = process.argv[2] || 8888,

    app      = connect()
              .use(limiter({
                whitelist: ['127.0.0.1'],
                end: false
              }))
              .use(function (req, res, next) {
                if (res.ratelimit.exceeded) {
                  res.statusCode = 429;
                  res.end('{"results": [], "error": "Rate limit exceeded"}');
                } else {
                  next();
                }
              })
              .use(connect.query())
              .use(connect.json())
              .use(noodlemw.parseQueries)
              .use(noodlemw.noodleQueries)
              .use(noodlemw.respond);

http.createServer(app).listen(port, function () {
  console.log('noodling on port ' + port);
});