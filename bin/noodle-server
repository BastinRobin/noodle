#!/usr/bin/env node

var connect  = require('connect'),
    http     = require('http'),
    noodlemw = require('../lib/noodle-middleware'),
    limiter  = require('connect-ratelimit'),

    limits   = getConfig().rateLimit,
    port     = process.argv[2] || 8888,
    app;

    limits.end = false;
    console.log(limits);
    app      = connect()
              .use(limiter(limits))
              .use(function (req, res, next) {
                if (res.ratelimit.exceeded) {
                  res.statusCode = 429;
                  res.end('[{"results": [], "error": "Rate limit exceeded"}]');
                } else {
                  next();
                }
              })
              .use(connect.query())
              .use(connect.json())
              .use(noodlemw.parseQueries)
              .use(noodlemw.noodleQueries)
              .use(noodlemw.respond);

http.createServer(app).listen(port, function () {
  console.log('noodling on port ' + port);
});

function getConfig () {
  var path   = require('path').resolve(__dirname, '../lib/config.json'),
      config = require('fs').readFileSync(path).toString();
  return JSON.parse(config);
}