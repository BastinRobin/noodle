#!/usr/bin/env node

var connect = require('connect'),
    http    = require('http'),
    scraper = require('../lib/scraper'),

    port    = process.argv[2] || 8888,

    app     = connect()
              .use(connect.query())
              .use(connect.json())
              .use(handle);


// Handle requested query via scraper module
// Recieves data via request body as JSON or as querystring

function handle (req, res) {
  // Check JSON Body for scrape query
  var query = (Object.keys(req.body).length > 0) ?  req.body : false;

  // Check querystring for scrape query
  if (!query && req.query.url && req.query.selector && req.query.extract) {
    query = {
              url: req.query.url,
              selector: req.query.selector,
              extract: req.query.extract
            };
  }

  if (query) {
    scraper.scrape(query, function (err, results) {
      finish(res, {error: err, results: results, callback: req.query.callback});
    });
  } else {
    finish(res, {error: 'No query', callback: req.query.callback});
  }
}

// Respond to request

function finish (res, params) {
  res.writeHead('200', {'Content-type':'application/json'});

  if (params.error && params.callback) {
    // Error as JSONP

    res.end(params.callback + '({"error": "' + params.error + '"})');

  } else if (params.error) {
    // Error as JSON

    res.end('{"error": "' + params.error + '"}');

  } else if (params.callback) {
    // Results as JSONP

    res.end(params.callback + '(' + params.results + ')');

  } else {
    // Results as JSON

    res.end(params.results);
  }
}


http.createServer(app).listen(port, function () {
  console.log('nsql serving on ' + port);
});